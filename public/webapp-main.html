<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cromwell Store - WebApp</title>
    <link rel="stylesheet" href="css/webapp.css" onerror="this.href='webapp.css'"> <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Estilos cr√≠ticos inline para asegurar que se vea algo */
        body { margin: 0; font-family: sans-serif; background: #0a0a1f; color: white; }
        .hidden { display: none !important; }
        .screen { display: none; padding-bottom: 80px; }
        .screen.active { display: block; }
        /* Toast styles basicos */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: #333; padding: 10px 20px; margin-bottom: 10px; border-radius: 4px; }
        /* Nav styles basicos por si falla el CSS */
        .main-nav { position: fixed; bottom: 0; width: 100%; background: #1a1a2e; display: flex; justify-content: space-around; padding: 10px 0; }
        .nav-item { background: none; border: none; color: #666; font-size: 24px; }
        .nav-item.active { color: #4f46e5; }
    </style>
</head>
<body>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            // Intentar obtener ID de varias fuentes
            let id = urlParams.get('userId') || localStorage.getItem('cromwell_telegram_id');
            
            // ID de respaldo para pruebas si no hay nada (SOLO DESARROLLO)
            if (!id && window.location.hostname === 'localhost') {
                id = '123456789'; 
                console.warn('‚ö†Ô∏è Usando ID de prueba localhost');
            }

            if (id) {
                window.TELEGRAM_USER_ID = id;
                localStorage.setItem('cromwell_telegram_id', id);
                console.log('‚úÖ ID Configurado:', window.TELEGRAM_USER_ID);
            } else {
                alert('Error: No User ID found. Abre desde Telegram.');
            }
        })();
    </script>

    <div id="app">
        <header style="padding: 20px; background: #1a1a2e; display: flex; justify-content: space-between;">
            <div>üè™ Cromwell Store</div>
            <div id="balance-cup">$0</div>
        </header>

        <main style="padding: 20px;">
            <div id="screen-dashboard" class="screen active">
                <h1 id="welcome-title">Cargando...</h1>
                <p id="welcome-subtitle">Espere un momento</p>
                
                <div style="background: #2d2d44; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h3>Saldos</h3>
                    <p>CUP: <strong id="dashboard-cup">---</strong></p>
                    <p>Saldo: <strong id="dashboard-saldo">---</strong></p>
                    <p>CWS: <strong id="dashboard-cws">---</strong></p>
                </div>

                <div style="margin-top: 20px;">
                    <p>ID: <code id="user-telegram-id">...</code></p>
                    <p>Tel: <span id="user-phone">...</span></p>
                </div>
            </div>

            <div id="screen-wallet" class="screen">
                <h2>Billetera</h2>
                <h1 id="wallet-cup">$0.00</h1>
                <p>Saldo M√≥vil: <span id="wallet-saldo">$0</span></p>
                <p>Tokens: <span id="wallet-cws">0</span></p>
            </div>
            
            <div id="screen-recharge" class="screen"><h2>Recargar</h2></div>
            <div id="screen-games" class="screen"><h2>Juegos</h2></div>
            <div id="screen-etecsa" class="screen"><h2>ETECSA</h2></div>
            <div id="screen-history" class="screen"><h2>Historial</h2></div>
        </main>

        <nav class="main-nav">
            <button class="nav-item active" data-screen="dashboard">üè†</button>
            <button class="nav-item" data-screen="wallet">üëõ</button>
            <button class="nav-item" data-screen="recharge">üí∞</button>
            <button class="nav-item" data-screen="games">üéÆ</button>
        </nav>
        
        <div id="loading-overlay" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000;">
            <div style="text-align: center;">
                <div style="font-size: 40px;">‚åõ</div>
                <p id="loading-text">Cargando...</p>
            </div>
        </div>
        
        <div id="toast-container" class="toast-container"></div>
    </div>

    <script>
        // Funci√≥n para cargar script asincronamente
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => {
                    // Intenta cargar sin /js/ si falla (por si est√° en raiz)
                    if (src.includes('/js/')) {
                        console.log('Reintentando cargar script desde ra√≠z...');
                        const retryScript = document.createElement('script');
                        retryScript.src = src.replace('/js/', ''); // Quitar prefijo carpeta
                        retryScript.onload = resolve;
                        retryScript.onerror = reject;
                        document.head.appendChild(retryScript);
                    } else {
                        reject();
                    }
                };
                document.head.appendChild(script);
            });
        }

        // Iniciar
        if (window.TELEGRAM_USER_ID) {
            // Intenta cargar webapp.js (ajusta la ruta si es necesario)
            // Primero prueba /js/webapp.js, si falla probar√° webapp.js
            loadScript('js/webapp.js') 
                .then(() => {
                    console.log('üìú Script cargado. Iniciando App...');
                    // Peque√±a pausa para asegurar DOM
                    setTimeout(() => {
                        if (typeof CromwellWebApp !== 'undefined') {
                            window.cromwellApp = new CromwellWebApp();
                        } else {
                            alert('Error: Clase CromwellWebApp no encontrada en el script.');
                        }
                    }, 100);
                })
                .catch((e) => {
                    console.error(e);
                    document.body.innerHTML = '<h2 style="color:red; text-align:center; margin-top:50px">Error: No se encontr√≥ webapp.js<br><small>Verifica que el archivo est√© en la carpeta correcta.</small></h2>';
                });
        }
    </script>
</body>
</html>
