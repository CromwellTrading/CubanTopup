<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cromwell Store - WebApp</title>
    <link rel="stylesheet" href="/css/webapp.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Script de inicializaci√≥n PRIMERO - SIN SCRIPT SRC ANTES -->
    <script>
        (function() {
            console.log('üîç Iniciando verificaci√≥n de usuario...');
            console.log('üîç URL completa:', window.location.href);
            console.log('üîç Par√°metros URL:', window.location.search);
            
            // Verificar que tenemos el userId
            const urlParams = new URLSearchParams(window.location.search);
            let telegramUserId = urlParams.get('userId');
            
            // Si no est√° en la URL, buscar en localStorage
            if (!telegramUserId) {
                telegramUserId = localStorage.getItem('cromwell_telegram_id');
                console.log('üîç ID desde localStorage:', telegramUserId);
            }
            
            // Si a√∫n no tenemos ID, mostrar error
            if (!telegramUserId) {
                console.error('‚ùå No se encontr√≥ ID de usuario');
                document.body.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: white; background: #0a0a1f; height: 100vh; font-family: Arial, sans-serif;">
                        <h2 style="color: #ef4444;">‚ùå Error de Acceso</h2>
                        <p>No se detect√≥ tu ID de Telegram.</p>
                        <p>Por favor, abre la WebApp desde el bot de Telegram.</p>
                        <div style="margin-top: 30px;">
                            <button onclick="window.location.href = '/webapp.html'" style="
                                background: #4f46e5;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                            ">
                                Volver a la pantalla de inicio
                            </button>
                        </div>
                    </div>
                `;
                throw new Error('Telegram User ID not found');
            }
            
            // Guardar para uso global INMEDIATAMENTE
            window.TELEGRAM_USER_ID = telegramUserId.toString();
            console.log('‚úÖ User ID cargado:', telegramUserId);
            
            // Tambi√©n guardar en localStorage por si acaso
            localStorage.setItem('cromwell_telegram_id', telegramUserId.toString());
            
            // Mostrar ID en pantalla mientras carga
            document.body.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; color: white; background: #0a0a1f; height: 100vh; font-family: Arial, sans-serif;">
                    <div class="logo" style="margin-bottom: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">üè™</div>
                        <div style="font-size: 1.5rem; color: #a5b4fc;">Cromwell Store</div>
                    </div>
                    <div class="loading" style="margin: 30px 0;">
                        <div style="border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p>Inicializando aplicaci√≥n...</p>
                        <p style="font-size: 12px; margin-top: 10px; color: #a5b4fc;">ID: ${telegramUserId}</p>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
        })();
    </script>
    
    <!-- Contenedor principal - SE CARGAR√Å DIN√ÅMICAMENTE -->
    <div id="app" style="display: none;">
        <!-- Cabecera -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üè™</span>
                    <span class="logo-text">Cromwell Store</span>
                </div>
                <div class="user-info" id="user-info">
                    <span class="user-balance" id="balance-cup">$0</span>
                    <span class="user-avatar" id="user-avatar">üë§</span>
                </div>
            </div>
            <div class="header-notification" id="header-notification" style="display: none;">
                <span id="notification-text"></span>
            </div>
        </header>

        <!-- Navegaci√≥n principal -->
        <nav class="main-nav">
            <div class="nav-grid">
                <button class="nav-item active" data-screen="dashboard">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label">Inicio</span>
                </button>
                <button class="nav-item" data-screen="wallet">
                    <span class="nav-icon">üëõ</span>
                    <span class="nav-label">Billetera</span>
                </button>
                <button class="nav-item" data-screen="recharge">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-label">Recargar</span>
                </button>
                <button class="nav-item" data-screen="games">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-label">Juegos</span>
                </button>
                <button class="nav-item" data-screen="etecsa">
                    <span class="nav-icon">üì±</span>
                    <span class="nav-label">ETECSA</span>
                </button>
                <button class="nav-item" data-screen="history">
                    <span class="nav-icon">üìú</span>
                    <span class="nav-label">Historial</span>
                </button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="app-content">
            <!-- Pantalla: Dashboard -->
            <div id="screen-dashboard" class="screen active">
                <div class="welcome-card">
                    <h1 id="welcome-title">¬°Bienvenido!</h1>
                    <p id="welcome-subtitle">Cargando informaci√≥n...</p>
                </div>

                <div class="balance-cards">
                    <div class="balance-card cup">
                        <div class="balance-icon">üí≥</div>
                        <div class="balance-info">
                            <span class="balance-label">CUP</span>
                            <span class="balance-amount" id="dashboard-cup">$0</span>
                        </div>
                    </div>
                    <div class="balance-card saldo">
                        <div class="balance-icon">üì±</div>
                        <div class="balance-info">
                            <span class="balance-label">Saldo M√≥vil</span>
                            <span class="balance-amount" id="dashboard-saldo">$0</span>
                        </div>
                    </div>
                    <div class="balance-card cws">
                        <div class="balance-icon">üé´</div>
                        <div class="balance-info">
                            <span class="balance-label">CWS</span>
                            <span class="balance-amount" id="dashboard-cws">0</span>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <h3>Acciones R√°pidas</h3>
                    <div class="action-grid">
                        <button class="action-btn" data-action="deposit-cup">
                            <span class="action-icon">üí≥</span>
                            <span>Recargar CUP</span>
                        </button>
                        <button class="action-btn" data-action="deposit-saldo">
                            <span class="action-icon">üì±</span>
                            <span>Recargar Saldo</span>
                        </button>
                        <button class="action-btn" data-action="show-games">
                            <span class="action-icon">üéÆ</span>
                            <span>Recargar Juegos</span>
                        </button>
                        <button class="action-btn" data-action="show-etecsa">
                            <span class="action-icon">üì∂</span>
                            <span>Recarga ETECSA</span>
                        </button>
                        <button class="action-btn" data-action="claim-payment">
                            <span class="action-icon">üéÅ</span>
                            <span>Reclamar Pago</span>
                        </button>
                        <button class="action-btn" data-action="history">
                            <span class="action-icon">üìä</span>
                            <span>Ver Historial</span>
                        </button>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Informaci√≥n Importante</h3>
                    <div class="info-card">
                        <p><strong>üÜî Tu ID de Telegram:</strong> <code id="user-telegram-id">-</code></p>
                        <p><strong>üìû Tel√©fono vinculado:</strong> <span id="user-phone">-</span></p>
                        <p><strong>üìù √öltima actividad:</strong> <span id="last-activity">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Billetera -->
            <div id="screen-wallet" class="screen">
                <div class="screen-header">
                    <h2>üëõ Mi Billetera</h2>
                    <button class="refresh-btn" id="refresh-wallet">üîÑ</button>
                </div>

                <div class="wallet-details">
                    <div class="wallet-section">
                        <h3>üìä Saldos Disponibles</h3>
                        <div class="balance-detail">
                            <div class="balance-row">
                                <span class="balance-label">üí≥ CUP</span>
                                <span class="balance-value" id="wallet-cup">$0</span>
                            </div>
                            <div class="balance-row">
                                <span class="balance-label">üì± Saldo M√≥vil</span>
                                <span class="balance-value" id="wallet-saldo">$0</span>
                            </div>
                            <div class="balance-row">
                                <span class="balance-label">üé´ CWS (Tokens)</span>
                                <span class="balance-value" id="wallet-cws">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="wallet-section">
                        <h3>üìû Informaci√≥n de Contacto</h3>
                        <div class="contact-info">
                            <p><strong>Tel√©fono vinculado:</strong> <span id="wallet-phone">-</span></p>
                            <button class="btn-secondary" id="change-phone">üìû Cambiar Tel√©fono</button>
                        </div>
                    </div>

                    <div class="wallet-section">
                        <h3>üí° Informaci√≥n √ötil</h3>
                        <div class="info-tips">
                            <div class="tip">
                                <span class="tip-icon">üéÆ</span>
                                <span>Usa CWS para descuentos en recargas de juegos</span>
                            </div>
                            <div class="tip">
                                <span class="tip-icon">üì±</span>
                                <span>Recargas ETECSA se pagan con saldo CUP</span>
                            </div>
                            <div class="tip">
                                <span class="tip-icon">‚ö†Ô∏è</span>
                                <span>M√≠nimo para usar CWS: 100 tokens</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Recargar Billetera -->
            <div id="screen-recharge" class="screen">
                <div class="screen-header">
                    <h2>üí∞ Recargar Billetera</h2>
                </div>

                <div class="recharge-options">
                    <h3>Selecciona M√©todo de Pago</h3>
                    <div class="method-cards">
                        <div class="method-card" data-method="cup">
                            <div class="method-icon">üí≥</div>
                            <div class="method-info">
                                <h4>CUP (Tarjeta)</h4>
                                <p>Dep√≥sito desde tarjeta bancaria</p>
                                <p class="method-min">M√≠nimo: $<span id="min-cup">1000</span></p>
                            </div>
                        </div>
                        <div class="method-card" data-method="saldo">
                            <div class="method-icon">üì±</div>
                            <div class="method-info">
                                <h4>Saldo M√≥vil</h4>
                                <p>Dep√≥sito desde Transferm√≥vil</p>
                                <p class="method-min">M√≠nimo: $<span id="min-saldo">500</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recharge-form hidden" id="recharge-form">
                    <h3 id="recharge-title">Recargar <span id="recharge-method"></span></h3>
                    
                    <div class="form-group">
                        <label for="amount">Monto a depositar</label>
                        <input type="number" id="amount" min="0" step="100" placeholder="Ej: 1000">
                        <div class="input-hint">
                            <span>M√≠nimo: $<span id="min-amount">1000</span></span>
                            <span>M√°ximo: $<span id="max-amount">50000</span></span>
                        </div>
                    </div>

                    <div class="bonus-info" id="bonus-info">
                        <h4>üéÅ Bono Disponible</h4>
                        <p>Primer dep√≥sito: <span id="bonus-percent">10%</span> de bono</p>
                        <p>Total a recibir: <span id="total-with-bonus">$0</span></p>
                    </div>

                    <div class="payment-info" id="payment-info">
                        <h4>üìã Instrucciones de Pago</h4>
                        <div id="payment-instructions">
                            <!-- Instrucciones din√°micas -->
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" id="confirm-deposit">‚úÖ Confirmar Dep√≥sito</button>
                        <button class="btn-secondary" id="cancel-deposit">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Recargar Juegos -->
            <div id="screen-games" class="screen">
                <div class="screen-header">
                    <h2>üéÆ Recargar Juegos</h2>
                    <button class="refresh-btn" id="refresh-games">üîÑ</button>
                </div>

                <div class="games-list" id="games-list">
                    <!-- Lista de juegos se carga din√°micamente -->
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando juegos...</p>
                    </div>
                </div>

                <div class="game-details hidden" id="game-details">
                    <!-- Detalles del juego seleccionado -->
                </div>

                <div class="game-payment hidden" id="game-payment">
                    <!-- Formulario de pago para juego -->
                </div>
            </div>

            <!-- Pantalla: Recargas ETECSA -->
            <div id="screen-etecsa" class="screen">
                <div class="screen-header">
                    <h2>üì± Recargas ETECSA</h2>
                    <button class="refresh-btn" id="refresh-etecsa">üîÑ</button>
                </div>

                <div class="etecsa-offers" id="etecsa-offers">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando ofertas...</p>
                    </div>
                </div>

                <div class="etecsa-form hidden" id="etecsa-form">
                    <!-- Formulario de recarga ETECSA -->
                </div>
            </div>

            <!-- Pantalla: Historial -->
            <div id="screen-history" class="screen">
                <div class="screen-header">
                    <h2>üìú Historial de Transacciones</h2>
                    <button class="refresh-btn" id="refresh-history">üîÑ</button>
                </div>

                <div class="history-filters">
                    <select id="filter-type">
                        <option value="all">Todas las transacciones</option>
                        <option value="DEPOSIT">Dep√≥sitos</option>
                        <option value="GAME_RECHARGE">Recargas Juegos</option>
                        <option value="ETECSA_RECHARGE">Recargas ETECSA</option>
                    </select>
                    <select id="filter-status">
                        <option value="all">Todos los estados</option>
                        <option value="completed">Completadas</option>
                        <option value="pending">Pendientes</option>
                        <option value="failed">Fallidas</option>
                    </select>
                </div>

                <div class="history-list" id="history-list">
                    <!-- Historial se carga din√°micamente -->
                </div>
            </div>

            <!-- Pantalla: Reclamar Pago -->
            <div id="screen-claim" class="screen">
                <div class="screen-header">
                    <h2>üéÅ Reclamar Pago</h2>
                </div>

                <div class="claim-options">
                    <p>Para pagos que no fueron detectados autom√°ticamente:</p>
                    <div class="option-cards">
                        <div class="option-card" data-option="search">
                            <div class="option-icon">üîç</div>
                            <div class="option-info">
                                <h4>Buscar por ID</h4>
                                <p>Usa el ID de la transacci√≥n de Transferm√≥vil</p>
                            </div>
                        </div>
                        <div class="option-card" data-option="pending">
                            <div class="option-icon">üìã</div>
                            <div class="option-info">
                                <h4>Ver Pendientes</h4>
                                <p>Pagos pendientes de reclamar</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="claim-form hidden" id="claim-search">
                    <h3>üîç Buscar por ID de Transacci√≥n</h3>
                    <div class="form-group">
                        <label for="tx-id">ID de Transacci√≥n</label>
                        <input type="text" id="tx-id" placeholder="Ej: TMW162915233">
                        <p class="form-hint">Encuentra el ID en tu SMS de Transferm√≥vil</p>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="search-payment">üîç Buscar</button>
                        <button class="btn-secondary" id="cancel-search">Cancelar</button>
                    </div>
                </div>

                <div class="pending-list hidden" id="pending-list">
                    <!-- Lista de pagos pendientes -->
                </div>
            </div>
        </main>

        <!-- Modal para cambios de tel√©fono -->
        <div class="modal hidden" id="phone-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìû Cambiar Tel√©fono Vinculado</h3>
                    <button class="modal-close" id="close-phone-modal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-phone">Nuevo n√∫mero de tel√©fono</label>
                        <input type="tel" id="new-phone" placeholder="5351234567" maxlength="10">
                        <p class="form-hint">Formato: 10 d√≠gitos, comenzando con 53</p>
                    </div>
                    <div class="current-phone">
                        <p><strong>Tel√©fono actual:</strong> <span id="current-phone-display">-</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="save-phone">üíæ Guardar</button>
                    <button class="btn-secondary" id="cancel-phone">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de confirmaci√≥n -->
        <div class="modal hidden" id="confirm-modal">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-icon" id="modal-icon">‚ö†Ô∏è</div>
                    <h3 id="modal-title">Confirmar Acci√≥n</h3>
                    <p id="modal-message">¬øEst√°s seguro de realizar esta acci√≥n?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="modal-confirm">‚úÖ Confirmar</button>
                    <button class="btn-secondary" id="modal-cancel">‚ùå Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Notificaciones toast -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Cargando overlay -->
        <div class="loading-overlay hidden" id="loading-overlay">
            <div class="loading-content">
                <div class="spinner large"></div>
                <p id="loading-text">Procesando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts - Cargar despu√©s de definir TELEGRAM_USER_ID -->
    <script>
        // Esperar a que se defina TELEGRAM_USER_ID
        function waitForUserId() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.TELEGRAM_USER_ID) {
                        clearInterval(checkInterval);
                        console.log('‚úÖ TELEGRAM_USER_ID encontrado:', window.TELEGRAM_USER_ID);
                        resolve();
                    }
                }, 100);
                
                // Timeout despu√©s de 5 segundos
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.error('‚ùå Timeout esperando TELEGRAM_USER_ID');
                    resolve();
                }, 5000);
            });
        }
        
        // Cargar scripts despu√©s de que el ID est√© disponible
        waitForUserId().then(() => {
            // Cargar los scripts din√°micamente
            const scripts = [
                '/js/webapp.js',
                '/js/components/wallet.js',
                '/js/components/games.js',
                '/js/components/etecsa.js',
                '/js/components/transactions.js'
            ];
            
            let loadedCount = 0;
            
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedCount++;
                    console.log(`‚úÖ Script cargado: ${src}`);
                    
                    // Cuando todos los scripts est√©n cargados
                    if (loadedCount === scripts.length) {
                        console.log('üöÄ Todos los scripts cargados, inicializando aplicaci√≥n...');
                        
                        // Peque√±o delay para asegurar
                        setTimeout(() => {
                            if (window.TELEGRAM_USER_ID) {
                                // Mostrar la aplicaci√≥n
                                document.getElementById('app').style.display = 'block';
                                // Quitar el loading screen
                                document.body.innerHTML = document.getElementById('app').outerHTML;
                                // Inicializar la aplicaci√≥n
                                document.addEventListener('DOMContentLoaded', () => {
                                    if (typeof CromwellWebApp !== 'undefined') {
                                        window.cromwellApp = new CromwellWebApp();
                                    } else {
                                        console.error('‚ùå CromwellWebApp no est√° definido');
                                        document.body.innerHTML = `
                                            <div style="padding: 40px 20px; text-align: center; font-family: Arial, sans-serif;">
                                                <h2 style="color: #dc3545;">‚ùå Error de Carga</h2>
                                                <p>No se pudo cargar la aplicaci√≥n.</p>
                                                <button onclick="location.reload()" style="
                                                    background: #4f46e5;
                                                    color: white;
                                                    border: none;
                                                    padding: 12px 24px;
                                                    border-radius: 8px;
                                                    cursor: pointer;
                                                    font-size: 16px;
                                                    margin-top: 20px;
                                                ">
                                                    Reintentar
                                                </button>
                                            </div>
                                        `;
                                    }
                                });
                            }
                        }, 300);
                    }
                };
                script.onerror = () => {
                    console.error(`‚ùå Error cargando script: ${src}`);
                    loadedCount++;
                };
                document.head.appendChild(script);
            });
        });
    </script>
</body>
</html>
