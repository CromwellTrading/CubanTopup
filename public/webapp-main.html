<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cromwell Store - WebApp</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="/css/webapp.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Pantalla de carga inicial -->
    <div id="loading-screen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a1f 0%, #121230 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-family: Arial, sans-serif;
    ">
        <div style="margin-bottom: 30px; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 10px;">üè™</div>
            <div style="font-size: 1.8rem; color: #a5b4fc; font-weight: bold;">Cromwell Store</div>
        </div>
        <div style="
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        "></div>
        <div id="loading-text" style="font-size: 1rem; margin-bottom: 5px;">Inicializando aplicaci√≥n...</div>
        <div id="user-id-display" style="font-size: 0.8rem; margin-top: 10px; color: #a5b4fc;"></div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </div>

    <!-- Aplicaci√≥n principal (oculta inicialmente) -->
    <div id="app" style="display: none;">
        <!-- Cabecera -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üè™</span>
                    <span class="logo-text">Cromwell Store</span>
                </div>
                <div class="user-info" id="user-info">
                    <span class="user-balance" id="balance-cup">$0</span>
                    <span class="user-avatar" id="user-avatar">üë§</span>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n principal -->
        <nav class="main-nav">
            <div class="nav-grid">
                <button class="nav-item active" data-screen="dashboard">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label">Inicio</span>
                </button>
                <button class="nav-item" data-screen="wallet">
                    <span class="nav-icon">üëõ</span>
                    <span class="nav-label">Billetera</span>
                </button>
                <button class="nav-item" data-screen="recharge">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-label">Recargar</span>
                </button>
                <button class="nav-item" data-screen="games">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-label">Juegos</span>
                </button>
                <button class="nav-item" data-screen="etecsa">
                    <span class="nav-icon">üì±</span>
                    <span class="nav-label">ETECSA</span>
                </button>
                <button class="nav-item" data-screen="history">
                    <span class="nav-icon">üìú</span>
                    <span class="nav-label">Historial</span>
                </button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="app-content">
            <!-- Pantalla: Dashboard -->
            <div id="screen-dashboard" class="screen active">
                <div class="welcome-card">
                    <h1 id="welcome-title">¬°Bienvenido!</h1>
                    <p id="welcome-subtitle">Cargando informaci√≥n...</p>
                </div>

                <div class="balance-cards">
                    <div class="balance-card cup">
                        <div class="balance-icon">üí≥</div>
                        <div class="balance-info">
                            <span class="balance-label">CUP</span>
                            <span class="balance-amount" id="dashboard-cup">$0</span>
                        </div>
                    </div>
                    <div class="balance-card saldo">
                        <div class="balance-icon">üì±</div>
                        <div class="balance-info">
                            <span class="balance-label">Saldo M√≥vil</span>
                            <span class="balance-amount" id="dashboard-saldo">$0</span>
                        </div>
                    </div>
                    <div class="balance-card cws">
                        <div class="balance-icon">üé´</div>
                        <div class="balance-info">
                            <span class="balance-label">CWS</span>
                            <span class="balance-amount" id="dashboard-cws">0</span>
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <h3>Acciones R√°pidas</h3>
                    <div class="action-grid">
                        <button class="action-btn" data-action="deposit-cup">
                            <span class="action-icon">üí≥</span>
                            <span>Recargar CUP</span>
                        </button>
                        <button class="action-btn" data-action="deposit-saldo">
                            <span class="action-icon">üì±</span>
                            <span>Recargar Saldo</span>
                        </button>
                        <button class="action-btn" data-action="show-games">
                            <span class="action-icon">üéÆ</span>
                            <span>Recargar Juegos</span>
                        </button>
                        <button class="action-btn" data-action="show-etecsa">
                            <span class="action-icon">üì∂</span>
                            <span>Recarga ETECSA</span>
                        </button>
                        <button class="action-btn" data-action="claim-payment">
                            <span class="action-icon">üéÅ</span>
                            <span>Reclamar Pago</span>
                        </button>
                        <button class="action-btn" data-action="history">
                            <span class="action-icon">üìä</span>
                            <span>Ver Historial</span>
                        </button>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Informaci√≥n del Usuario</h3>
                    <div class="info-card">
                        <p><strong>üÜî ID de Telegram:</strong> <code id="user-telegram-id">-</code></p>
                        <p><strong>üìû Tel√©fono vinculado:</strong> <span id="user-phone">-</span></p>
                        <p><strong>üìù √öltima actividad:</strong> <span id="last-activity">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Billetera -->
            <div id="screen-wallet" class="screen">
                <div class="screen-header">
                    <h2>üëõ Mi Billetera</h2>
                    <button class="refresh-btn" id="refresh-wallet">üîÑ</button>
                </div>

                <div class="wallet-details">
                    <div class="wallet-section">
                        <h3>üìä Saldos Disponibles</h3>
                        <div class="balance-detail">
                            <div class="balance-row">
                                <span class="balance-label">üí≥ CUP</span>
                                <span class="balance-value" id="wallet-cup">$0</span>
                            </div>
                            <div class="balance-row">
                                <span class="balance-label">üì± Saldo M√≥vil</span>
                                <span class="balance-value" id="wallet-saldo">$0</span>
                            </div>
                            <div class="balance-row">
                                <span class="balance-label">üé´ CWS (Tokens)</span>
                                <span class="balance-value" id="wallet-cws">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="wallet-section">
                        <h3>üìû Informaci√≥n de Contacto</h3>
                        <div class="contact-info">
                            <p><strong>Tel√©fono vinculado:</strong> <span id="wallet-phone">-</span></p>
                            <button class="btn-secondary" id="change-phone">üìû Cambiar Tel√©fono</button>
                        </div>
                    </div>

                    <div class="wallet-section">
                        <h3>üí° Informaci√≥n √ötil</h3>
                        <div class="info-card">
                            <p>üéÆ Usa CWS para descuentos en recargas de juegos</p>
                            <p>üì± Recargas ETECSA se pagan con saldo CUP</p>
                            <p>‚ö†Ô∏è M√≠nimo para usar CWS: <span id="min-cws-use">100</span> tokens</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Recargar -->
            <div id="screen-recharge" class="screen">
                <div class="screen-header">
                    <h2>üí∞ Recargar Billetera</h2>
                </div>

                <div class="recharge-options">
                    <h3>Selecciona M√©todo de Pago</h3>
                    <div class="method-cards">
                        <div class="method-card" data-method="cup">
                            <div class="method-icon">üí≥</div>
                            <div class="method-info">
                                <h4>CUP (Tarjeta)</h4>
                                <p>Dep√≥sito desde tarjeta bancaria</p>
                                <p class="method-min">M√≠nimo: $<span id="min-cup">1000</span></p>
                            </div>
                        </div>
                        <div class="method-card" data-method="saldo">
                            <div class="method-icon">üì±</div>
                            <div class="method-info">
                                <h4>Saldo M√≥vil</h4>
                                <p>Dep√≥sito desde Transferm√≥vil</p>
                                <p class="method-min">M√≠nimo: $<span id="min-saldo">500</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recharge-form hidden" id="recharge-form">
                    <h3>Recargar <span id="recharge-method"></span></h3>
                    
                    <div class="form-group">
                        <label for="amount">Monto a depositar</label>
                        <input type="number" id="amount" min="0" step="100" placeholder="Ej: 1000">
                        <div class="input-hint">
                            <span>M√≠nimo: $<span id="min-amount">1000</span></span>
                            <span>M√°ximo: $<span id="max-amount">50000</span></span>
                        </div>
                    </div>

                    <div class="bonus-info" id="bonus-info" style="display: none;">
                        <h4>üéÅ Bono Disponible</h4>
                        <p>Primer dep√≥sito: <span id="bonus-percent">10%</span> de bono</p>
                        <p>Total a recibir: <span id="total-with-bonus">$0</span></p>
                    </div>

                    <div class="payment-info" id="payment-info">
                        <h4>üìã Instrucciones de Pago</h4>
                        <div id="payment-instructions">
                            <!-- Instrucciones din√°micas -->
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" id="confirm-deposit">‚úÖ Confirmar Dep√≥sito</button>
                        <button class="btn-secondary" id="cancel-deposit">‚ùå Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Pantalla: Juegos -->
            <div id="screen-games" class="screen">
                <div class="screen-header">
                    <h2>üéÆ Recargar Juegos</h2>
                    <button class="refresh-btn" id="refresh-games">üîÑ</button>
                </div>

                <div class="games-list" id="games-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando juegos...</p>
                    </div>
                </div>

                <div class="game-details hidden" id="game-details">
                    <!-- Detalles del juego seleccionado -->
                </div>

                <div class="game-payment hidden" id="game-payment">
                    <!-- Formulario de pago para juego -->
                </div>
            </div>

            <!-- Pantalla: ETECSA -->
            <div id="screen-etecsa" class="screen">
                <div class="screen-header">
                    <h2>üì± Recargas ETECSA</h2>
                    <button class="refresh-btn" id="refresh-etecsa">üîÑ</button>
                </div>

                <div class="etecsa-offers" id="etecsa-offers">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando ofertas...</p>
                    </div>
                </div>

                <div class="etecsa-form hidden" id="etecsa-form">
                    <!-- Formulario de recarga ETECSA -->
                </div>
            </div>

            <!-- Pantalla: Historial -->
            <div id="screen-history" class="screen">
                <div class="screen-header">
                    <h2>üìú Historial de Transacciones</h2>
                    <button class="refresh-btn" id="refresh-history">üîÑ</button>
                </div>

                <div class="history-filters">
                    <select id="filter-type">
                        <option value="all">Todas las transacciones</option>
                        <option value="DEPOSIT">Dep√≥sitos</option>
                        <option value="GAME_RECHARGE">Recargas Juegos</option>
                        <option value="ETECSA_RECHARGE">Recargas ETECSA</option>
                    </select>
                    <select id="filter-status">
                        <option value="all">Todos los estados</option>
                        <option value="completed">Completadas</option>
                        <option value="pending">Pendientes</option>
                        <option value="failed">Fallidas</option>
                    </select>
                </div>

                <div class="history-list" id="history-list">
                    <!-- Historial se carga din√°micamente -->
                </div>
            </div>

            <!-- Pantalla: Reclamar Pago -->
            <div id="screen-claim" class="screen">
                <div class="screen-header">
                    <h2>üéÅ Reclamar Pago</h2>
                </div>

                <div class="claim-options">
                    <p>Para pagos que no fueron detectados autom√°ticamente:</p>
                    <div class="option-cards">
                        <div class="option-card" data-option="search">
                            <div class="option-icon">üîç</div>
                            <div class="option-info">
                                <h4>Buscar por ID</h4>
                                <p>Usa el ID de la transacci√≥n de Transferm√≥vil</p>
                            </div>
                        </div>
                        <div class="option-card" data-option="pending">
                            <div class="option-icon">üìã</div>
                            <div class="option-info">
                                <h4>Ver Pendientes</h4>
                                <p>Pagos pendientes de reclamar</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="claim-form hidden" id="claim-search">
                    <h3>üîç Buscar por ID de Transacci√≥n</h3>
                    <div class="form-group">
                        <label for="tx-id">ID de Transacci√≥n</label>
                        <input type="text" id="tx-id" placeholder="Ej: TMW162915233">
                        <p class="form-hint">Encuentra el ID en tu SMS de Transferm√≥vil</p>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="search-payment">üîç Buscar</button>
                        <button class="btn-secondary" id="cancel-search">Cancelar</button>
                    </div>
                </div>

                <div class="pending-list hidden" id="pending-list">
                    <!-- Lista de pagos pendientes -->
                </div>
            </div>
        </main>

        <!-- Modal para cambios de tel√©fono -->
        <div class="modal hidden" id="phone-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìû Cambiar Tel√©fono Vinculado</h3>
                    <button class="modal-close" id="close-phone-modal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="new-phone">Nuevo n√∫mero de tel√©fono</label>
                        <input type="tel" id="new-phone" placeholder="5351234567" maxlength="10">
                        <p class="form-hint">Formato: 10 d√≠gitos, comenzando con 53</p>
                    </div>
                    <div class="current-phone">
                        <p><strong>Tel√©fono actual:</strong> <span id="current-phone-display">-</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="save-phone">üíæ Guardar</button>
                    <button class="btn-secondary" id="cancel-phone">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de confirmaci√≥n -->
        <div class="modal hidden" id="confirm-modal">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="modal-icon" id="modal-icon">‚ö†Ô∏è</div>
                    <h3 id="modal-title">Confirmar Acci√≥n</h3>
                    <p id="modal-message">¬øEst√°s seguro de realizar esta acci√≥n?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="modal-confirm">‚úÖ Confirmar</button>
                    <button class="btn-secondary" id="modal-cancel">‚ùå Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay hidden" id="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loading-text-modal">Procesando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts de la aplicaci√≥n -->
    <script>
        // ============================================
        // INICIALIZACI√ìN Y DETECCI√ìN DE USUARIO
        // ============================================
        
        console.log('üîç Iniciando verificaci√≥n de usuario...');
        
        // Obtener userId de diferentes fuentes
        const urlParams = new URLSearchParams(window.location.search);
        let telegramUserId = urlParams.get('userId');
        
        // Si no est√° en la URL, buscar en localStorage
        if (!telegramUserId) {
            telegramUserId = localStorage.getItem('cromwell_telegram_id');
            console.log('üîç ID desde localStorage:', telegramUserId);
        }
        
        // Si a√∫n no tenemos ID, intentar desde Telegram WebApp
        if (!telegramUserId && window.Telegram?.WebApp?.initDataUnsafe?.user) {
            telegramUserId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
            console.log('üîç ID desde Telegram WebApp:', telegramUserId);
        }
        
        // Mostrar ID en pantalla de carga
        const userIdDisplay = document.getElementById('user-id-display');
        if (userIdDisplay && telegramUserId) {
            userIdDisplay.textContent = `ID: ${telegramUserId}`;
        }
        
        // Funci√≥n para mostrar error
        function showError(message) {
            document.getElementById('loading-screen').innerHTML = `
                <div style="padding: 40px 20px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 20px; color: #ef4444;">‚ùå</div>
                    <h2 style="color: #ef4444; margin-bottom: 15px;">Error</h2>
                    <p style="margin-bottom: 25px; color: #e5e7eb;">${message}</p>
                    <button onclick="location.reload()" style="
                        background: #4f46e5;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                    ">
                        Reintentar
                    </button>
                </div>
            `;
        }
        
        // Si no tenemos ID, mostrar error
        if (!telegramUserId) {
            console.error('‚ùå No se encontr√≥ ID de usuario');
            showError('No se detect√≥ tu ID de Telegram.<br>Por favor, abre la WebApp desde el bot.');
            throw new Error('Telegram User ID not found');
        }
        
        // Guardar para uso global
        window.TELEGRAM_USER_ID = telegramUserId.toString();
        localStorage.setItem('cromwell_telegram_id', telegramUserId.toString());
        
        console.log('‚úÖ User ID cargado:', telegramUserId);
        
        // Funci√≥n para cargar scripts din√°micamente
        function loadScripts(scripts, callback) {
            let loadedCount = 0;
            
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        console.log(`‚úÖ Script cargado: ${src}`);
                        loadedCount++;
                        resolve();
                    };
                    script.onerror = (error) => {
                        console.error(`‚ùå Error cargando script: ${src}`, error);
                        loadedCount++;
                        resolve(); // Continuar incluso si hay error
                    };
                    document.head.appendChild(script);
                });
            }
            
            // Cargar todos los scripts en orden
            Promise.all(scripts.map(script => loadScript(script)))
                .then(() => {
                    console.log(`‚úÖ Todos los scripts cargados (${loadedCount}/${scripts.length})`);
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('‚ùå Error cargando scripts:', error);
                    if (callback) callback();
                });
        }
        
        // Funci√≥n principal de inicializaci√≥n
        async function initializeApp() {
            console.log('üöÄ Inicializando aplicaci√≥n...');
            
            // Lista de scripts a cargar (en orden CORRECTO)
            const scripts = [
                '/js/webapp.js',
                '/js/components/etecsa.js',
                '/js/components/wallet.js',
                '/js/components/transactions.js'
            ];
            
            // Cargar scripts
            loadScripts(scripts, () => {
                console.log('üì¶ Scripts cargados, mostrando aplicaci√≥n...');
                
                // Ocultar pantalla de carga y mostrar aplicaci√≥n
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Verificar que las clases necesarias est√©n disponibles
                if (typeof CromwellWebApp === 'undefined') {
                    console.error('‚ùå CromwellWebApp no est√° definido');
                    showError('Error cargando la aplicaci√≥n. Por favor, recarga la p√°gina.');
                    return;
                }
                
                if (typeof EtecsaComponent === 'undefined') {
                    console.error('‚ùå EtecsaComponent no est√° definido');
                    showError('Error cargando componente ETECSA. Por favor, recarga la p√°gina.');
                    return;
                }
                
                // Inicializar la aplicaci√≥n
                try {
                    window.cromwellApp = new CromwellWebApp();
                    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                } catch (error) {
                    console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                    showError('Error inicializando la aplicaci√≥n: ' + error.message);
                }
            });
        }
        
        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
